<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spring_react.spring_react.chat.ChatMapper">

    <select id="getChatRooms"
            parameterType="int"
            resultType="com.spring_react.spring_react.command.ChatRoomVO">

        SELECT
            cr.room_id    AS roomId,
            cr.book_id    AS bookId,
            cr.seller_id  AS sellerId,
            cr.buyer_id   AS buyerId,
            cr.created_at AS createdAt,

            su.login_id   AS sellerLoginId,
            bu.login_id   AS buyerLoginId,

            b.title       AS bookTitle,
            b.status      AS productStatus,
            b.price       AS price,

            (
                SELECT bi.image_url
                FROM book_image bi
                WHERE bi.book_id = cr.book_id
                  AND bi.is_thumbnail = true
                             LIMIT 1
            ) AS imageUrl,

        (
            SELECT cm.content
            FROM chat_message cm
            WHERE cm.room_id = cr.room_id
            ORDER BY cm.sent_at DESC
            LIMIT 1
        ) AS lastMessage,

        (
            SELECT DATE_FORMAT(cm.sent_at, '%Y-%m-%d %H:%i')
            FROM chat_message cm
            WHERE cm.room_id = cr.room_id
            ORDER BY cm.sent_at DESC
            LIMIT 1
        ) AS lastTime

        FROM chat_room cr
            JOIN book b ON cr.book_id = b.book_id
            JOIN users su ON cr.seller_id = su.user_id
            JOIN users bu ON cr.buyer_id  = bu.user_id
        WHERE cr.seller_id = #{userId}
           OR cr.buyer_id  = #{userId}
        ORDER BY cr.created_at DESC
    </select>


    <select id="selectChatRoom"
            parameterType="com.spring_react.spring_react.command.ChatRoomVO"
            resultType="com.spring_react.spring_react.command.ChatRoomVO">

        SELECT
            room_id    AS roomId,
            book_id    AS bookId,
            seller_id  AS sellerId,
            buyer_id   AS buyerId,
            created_at AS createdAt
        FROM chat_room
        WHERE book_id   = #{bookId}
          AND seller_id = #{sellerId}
          AND buyer_id  = #{buyerId}
            LIMIT 1
    </select>

    <insert id="insertChatRoom"
            parameterType="com.spring_react.spring_react.command.ChatRoomVO"
            useGeneratedKeys="true"
            keyProperty="roomId">

        INSERT INTO chat_room (
            book_id,
            seller_id,
            buyer_id
        ) VALUES (
                     #{bookId},
                     #{sellerId},
                     #{buyerId}
                 )
    </insert>

    <select id="selectMessagesByRoomId"
            parameterType="int"
            resultType="com.spring_react.spring_react.command.ChatMessageVO">

        SELECT
            message_id AS messageId,
            room_id    AS roomId,
            sender_id  AS senderId,
            content,
            sent_at    AS sentAt
        FROM chat_message
        WHERE room_id = #{roomId}
        ORDER BY sent_at ASC
    </select>

    <insert id="insertChatMessage"
            parameterType="com.spring_react.spring_react.command.ChatMessageVO"
            useGeneratedKeys="true"
            keyProperty="messageId">

        INSERT INTO chat_message (
            room_id,
            sender_id,
            content,
            sent_at
        ) VALUES (
                     #{roomId},
                     #{senderId},
                     #{content},
                     #{sentAt}
                 )
    </insert>

    <select id="getChatRoomDetail"
            parameterType="int"
            resultType="com.spring_react.spring_react.command.ChatRoomVO">

        SELECT
            cr.room_id    AS roomId,
            cr.book_id    AS bookId,
            cr.seller_id  AS sellerId,
            cr.buyer_id   AS buyerId,
            cr.created_at AS createdAt,

            b.title       AS bookTitle,
            b.status      AS productStatus,
            b.price       AS price,

            (
                SELECT bi.image_url
                FROM book_image bi
                WHERE bi.book_id = cr.book_id
                  AND bi.is_thumbnail = true
                             LIMIT 1
            ) AS imageUrl,

        NULL AS lastMessage,
        NULL AS lastTime

        FROM chat_room cr
            JOIN book b ON cr.book_id = b.book_id
        WHERE cr.room_id = #{roomId}
    </select>


</mapper>
